# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
    push:
        branches: [main, release]
    pull_request:
        branches: [main, release]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - uses: actions/checkout@v2

            # Use NodeJS v14.19.0
            - uses: actions/setup-node@v2
              with:
                  node-version: '20.16.0'

            # Run npm install
            - name: Run npm install
              run: npm install --legacy-peer-deps

            # Runs linter
            - name: Run linter
              run: npm run lint

            # Runs tests
            - name: Run tests
              run: npm test

            # Collect coverage report
            - uses: 5monkeys/cobertura-action@master
              continue-on-error: true
              with:
                  path: coverage/sdk/cobertura-coverage.xml
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  minimum_coverage: 0

            # Runs TypeScript compiler
            - name: Run TypeScript compiler
              run: npm run tsc

            # Run size check
            - name: Run npm check-size
              run: npm run check-size

            # Collect artifacts
            - uses: actions/upload-artifact@v4
              with:
                  name: test-coverage
                  path: coverage/

            # Create new package release
            - name: Publish dev package
              run: npx pkg-pr-new publish

    # CSS Variables validation job
    css-validation:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Checkout theme builder repo
              uses: actions/checkout@v2
              with:
                  repository: thoughtspot/Thoughtspot-theme-builder
                  path: theme-builder
                  ref: release
                  token: ${{ secrets.THEME_BUILDER_TOKEN }}
                  fetch-depth: 1

            - name: Verify checkout and file access
              run: |
                  echo "üîç Verifying checkout..."
                  echo "Current directory: $(pwd)"
                  echo "Theme builder directory contents:"
                  ls -la theme-builder/ || echo "Theme builder directory not found"
                  echo ""
                  
                  echo "Checking for the target file..."
                  if [ -f "theme-builder/src/data/sdkVariable.ts" ]; then
                      echo "‚úÖ Found target file: theme-builder/src/data/sdkVariable.ts"
                      echo "File size: $(wc -c < theme-builder/src/data/sdkVariable.ts) bytes"
                      echo "First few lines:"
                      head -5 theme-builder/src/data/sdkVariable.ts
                  else
                      echo "‚ùå Target file not found: theme-builder/src/data/sdkVariable.ts"
                      echo "Available files in src/data/:"
                      ls -la theme-builder/src/data/ 2>/dev/null || echo "src/data directory not found"
                      echo ""
                      echo "Available files in src/:"
                      ls -la theme-builder/src/ 2>/dev/null || echo "src directory not found"
                      exit 1
                  fi

            - name: Validate CSS variables
              run: |
                  echo "üîç Starting CSS variables validation..."
                  echo "üìÅ Using theme builder file: theme-builder/src/data/sdkVariable.ts"
                  echo "üìã Running validation..."
                  node scripts/validate-css-variables.js "$(cat theme-builder/src/data/sdkVariable.ts)"
                  echo "‚úÖ Validation completed!"
