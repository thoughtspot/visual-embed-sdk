# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
    push:
        branches: [main, release]
    pull_request:
        branches: [main, release]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    # This workflow contains a single job called "build"
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        # Steps represent a sequence of tasks that will be executed as part of the job
        steps:
            # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
            - uses: actions/checkout@v2

            # Use NodeJS v14.19.0
            - uses: actions/setup-node@v2
              with:
                  node-version: '20.16.0'

            # Run npm install
            - name: Run npm install
              run: npm install --legacy-peer-deps

            # Runs linter
            - name: Run linter
              run: npm run lint

            # Runs tests
            - name: Run tests
              run: npm test

            # Collect coverage report
            - uses: 5monkeys/cobertura-action@master
              continue-on-error: true
              with:
                  path: coverage/sdk/cobertura-coverage.xml
                  repo_token: ${{ secrets.GITHUB_TOKEN }}
                  minimum_coverage: 0

            # Runs TypeScript compiler
            - name: Run TypeScript compiler
              run: npm run tsc

            # Run size check
            - name: Run npm check-size
              run: npm run check-size

            # Collect artifacts
            - uses: actions/upload-artifact@v4
              with:
                  name: test-coverage
                  path: coverage/

            # Create new package release
            - name: Publish dev package
              run: npx pkg-pr-new publish

    # CSS Variables validation job
    css-validation:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Test repository access
              run: |
                  echo "üîç Testing repository access..."
                  echo "Repository: thoughtspot/Thoughtspot-theme-builder"
                  echo "Branch: release"
                  echo "Token present: ${{ secrets.THEME_BUILDER_TOKEN != '' }}"
                  
                  # Test repository access
                  echo "Making API call to GitHub..."
                  RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.THEME_BUILDER_TOKEN }}" \
                      "https://api.github.com/repos/thoughtspot/Thoughtspot-theme-builder")
                  
                  echo "API Response:"
                  echo "$RESPONSE"
                  echo ""
                  
                  if echo "$RESPONSE" | grep -q "full_name"; then
                      echo "‚úÖ Repository access confirmed"
                      
                      # Test branch access
                      echo "Testing branch access..."
                      BRANCH_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.THEME_BUILDER_TOKEN }}" \
                          "https://api.github.com/repos/thoughtspot/Thoughtspot-theme-builder/branches/release")
                      
                      echo "Branch API Response:"
                      echo "$BRANCH_RESPONSE"
                      echo ""
                      
                      if echo "$BRANCH_RESPONSE" | grep -q "name"; then
                          echo "‚úÖ Release branch access confirmed"
                      else
                          echo "‚ùå Release branch not found or not accessible"
                          echo "Available branches:"
                          curl -s -H "Authorization: token ${{ secrets.THEME_BUILDER_TOKEN }}" \
                              "https://api.github.com/repos/thoughtspot/Thoughtspot-theme-builder/branches" | \
                              jq -r '.[].name' 2>/dev/null || echo "Could not fetch branches"
                          exit 1
                      fi
                  else
                      echo "‚ùå Cannot access repository"
                      echo "Possible issues:"
                      echo "1. Token doesn't have access to this repository"
                      echo "2. Token is invalid or expired"
                      echo "3. Repository permissions issue"
                      echo "4. Repository doesn't exist"
                      exit 1
                  fi

            - name: Checkout theme builder repo
              uses: actions/checkout@v2
              with:
                  repository: thoughtspot/Thoughtspot-theme-builder
                  path: theme-builder
                  ref: release
                  token: ${{ secrets.THEME_BUILDER_TOKEN }}

            - name: Validate CSS variables
              run: |
                  echo "üîç Starting CSS variables validation..."
                  echo "üìÅ Checking theme builder file..."
                  ls -la theme-builder/src/data/sdkVariable.ts
                  echo "üìã Running validation..."
                  node scripts/validate-css-variables.js "$(cat theme-builder/src/data/sdkVariable.ts)"
                  echo "‚úÖ Validation completed!"
