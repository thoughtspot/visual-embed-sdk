name: bump-version-and-pr

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major
      email:
        description: "Email ID of the tse-developer user account"
        type: string
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
            node-version: '20.19.4'
            registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config user.name "tse-developer"
          git config user.email "${{ github.event.inputs.email }}"

      - name: Bump version
        id: bump
        run: |
          NEW_VERSION=$(npm version "${{ github.event.inputs.bump }}" --no-git-tag-version)
          # npm version returns "vX.Y.Z" â€“ strip the leading v
          NEW_VERSION=${NEW_VERSION#v}
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Branch will be $NEW_VERSION"

      - name: Install (lockfile refresh if needed)
        run: npm install --package-lock-only

      - name: Commit changes
        run: |
          BRANCH="${{ steps.bump.outputs.new_version }}"
          git checkout -b "$BRANCH"
          git status
          git add package.json package-lock.json
          git commit -m "chore: bump version to v${{ steps.bump.outputs.new_version }}"

      - name: Push branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.bump.outputs.new_version }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.bump.outputs.new_version }}"
          BODY="## Summary: Bumped version to v${{ steps.bump.outputs.new_version }}"
          TITLE="chore: release v${{ steps.bump.outputs.new_version }}"
          gh pr create \
            --title "$TITLE" \
            --body "$BODY" \
            --base main \
            --head "$BRANCH" \
